<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Optimizer â€“ User Profile & Session Input</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .glow {
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        .stars-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle linear infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0;
                transform: translateY(0);
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translateY(100vh);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .clock-glow {
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.5), 0 0 40px rgba(139, 92, 246, 0.3);
        }

        .session-active {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Stars Background -->
    <div class="stars-bg" id="stars-container"></div>

    <!-- Navigation -->
    <nav class="border-b border-slate-800 bg-slate-950/50 backdrop-blur-sm sticky top-0 z-50 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center">
                        <i data-lucide="moon" class="w-5 h-5 text-violet-400" style="stroke-width: 1.5;"></i>
                    </div>
                    <span class="text-lg font-semibold tracking-tight">Sleep Optimizer</span>
                </div>
                <div class="text-sm text-slate-400">
                    Worker Agent Interface
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 relative z-10">
        <!-- Page Header -->
        <div class="text-center mb-12">
            <h1
                class="text-5xl sm:text-6xl font-light tracking-tight mb-4 text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-purple-400">
                Sleep Optimizer
            </h1>
            <p class="text-xl text-slate-400 max-w-2xl mx-auto">
                User Profile & Session Input
            </p>
        </div>

        <!-- User Profile Section -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center">
                    <i data-lucide="user" class="w-6 h-6 text-violet-400" style="stroke-width: 1.5;"></i>
                </div>
                <h2 class="text-2xl font-semibold">User Profile</h2>
            </div>

            <form id="profile-form" class="grid md:grid-cols-2 gap-6">
                <!-- Age -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Age</label>
                    <input type="number" id="age" name="age" min="1" max="120" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                </div>

                <!-- Work Schedule -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Work Schedule</label>
                    <div class="relative">
                        <select id="work_schedule" name="work_schedule" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent appearance-none cursor-pointer transition-all">
                            <option value="9am-5pm">9 AM - 5 PM</option>
                            <option value="flexible">Flexible</option>
                            <option value="night-shift">Night Shift</option>
                            <option value="rotating">Rotating Shifts</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 text-slate-400 absolute right-3 top-3 pointer-events-none"
                            style="stroke-width: 1.5;"></i>
                    </div>
                </div>

                <!-- Caffeine Intake -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Caffeine Intake</label>
                    <div class="relative">
                        <select id="caffeine_intake" name="caffeine_intake" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent appearance-none cursor-pointer transition-all">
                            <option value="none">None</option>
                            <option value="low">Low (1-2 cups/day)</option>
                            <option value="medium">Medium (3-4 cups/day)</option>
                            <option value="high">High (>4 cups/day)</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 text-slate-400 absolute right-3 top-3 pointer-events-none"
                            style="stroke-width: 1.5;"></i>
                    </div>
                </div>

                <!-- Screen Time -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">
                        Screen Time Before Bed
                        <span id="screen-time-value" class="text-violet-400 ml-2">2 hours</span>
                    </label>
                    <input type="range" id="screen_time" name="screen_time" min="0" max="6" step="0.5" value="2"
                        class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500">
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>0h</span>
                        <span>6h</span>
                    </div>
                </div>

                <!-- Exercise Frequency -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Exercise Frequency</label>
                    <div class="relative">
                        <select id="exercise" name="exercise" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent appearance-none cursor-pointer transition-all">
                            <option value="daily">Daily</option>
                            <option value="3-4-times">3-4 times per week</option>
                            <option value="1-2-times">1-2 times per week</option>
                            <option value="rarely">Rarely</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 text-slate-400 absolute right-3 top-3 pointer-events-none"
                            style="stroke-width: 1.5;"></i>
                    </div>
                </div>

                <!-- Stress Level -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">
                        Stress Level
                        <span id="stress-level-value" class="text-violet-400 ml-2">3</span>
                    </label>
                    <input type="range" id="stress_level" name="stress_level" min="1" max="5" value="3"
                        class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500">
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sleep Clock Tracker Section -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center">
                    <i data-lucide="clock" class="w-6 h-6 text-violet-400" style="stroke-width: 1.5;"></i>
                </div>
                <h2 class="text-2xl font-semibold">Sleep Clock Tracker</h2>
            </div>

            <!-- Current Time Display -->
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-slate-700 mb-4">
                    <i data-lucide="clock" class="w-4 h-4 text-slate-400" style="stroke-width: 1.5;"></i>
                    <span class="text-sm text-slate-400">Current Time</span>
                </div>
                <div id="current-time"
                    class="text-5xl sm:text-6xl font-light tracking-tight mb-2 clock-glow text-violet-300">--:--:--
                </div>
                <div id="current-date" class="text-slate-400 text-sm"></div>
            </div>

            <!-- Sleep Session Card -->
            <div class="bg-slate-800/30 border border-slate-700 rounded-xl p-6 mb-6">
                <div class="text-center mb-6">
                    <div id="session-status"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800 text-sm mb-4">
                        <div class="w-2 h-2 rounded-full bg-slate-500"></div>
                        <span>No active session</span>
                    </div>
                    <div id="sleep-timer" class="text-4xl font-light tracking-tight text-violet-400 mb-2 clock-glow">
                        00:00:00</div>
                    <div id="session-info" class="text-slate-500 text-sm"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="start-btn" onclick="startSleep()"
                        class="flex items-center justify-center gap-2 px-6 py-3 bg-violet-500 hover:bg-violet-600 text-white rounded-xl font-medium transition-all hover:scale-105">
                        <i data-lucide="moon-star" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                        Start Sleep
                    </button>
                    <button id="pause-btn" onclick="pauseSleep()" disabled
                        class="flex items-center justify-center gap-2 px-6 py-3 bg-slate-800 text-slate-400 rounded-xl font-medium transition-colors hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-slate-800">
                        <i data-lucide="pause" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                        Pause
                    </button>
                    <button id="wake-btn" onclick="wakeSleep()" disabled
                        class="flex items-center justify-center gap-2 px-6 py-3 bg-slate-800 text-slate-400 rounded-xl font-medium transition-colors hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-slate-800">
                        <i data-lucide="sunrise" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                        Wake Up
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-slate-800/30 border border-slate-700 rounded-xl p-4">
                    <div class="text-slate-400 text-xs mb-1">Total Pauses</div>
                    <div id="total-pauses" class="text-2xl font-semibold">0</div>
                </div>
                <div class="bg-slate-800/30 border border-slate-700 rounded-xl p-4">
                    <div class="text-slate-400 text-xs mb-1">Interruptions</div>
                    <div id="interruption-count" class="text-2xl font-semibold">0</div>
                </div>
                <div class="bg-slate-800/30 border border-slate-700 rounded-xl p-4">
                    <div class="text-slate-400 text-xs mb-1">Last Session</div>
                    <div id="last-sleep" class="text-2xl font-semibold">--</div>
                </div>
            </div>
        </div>

        <!-- Add New Sleep Session Section -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center">
                        <i data-lucide="plus-circle" class="w-6 h-6 text-violet-400" style="stroke-width: 1.5;"></i>
                    </div>
                    <h2 class="text-2xl font-semibold">Add New Sleep Session</h2>
                </div>
                <button onclick="quickAddLastNight()"
                    class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-medium transition-colors">
                    <i data-lucide="clock" class="w-4 h-4 inline mr-2" style="stroke-width: 1.5;"></i>
                    Quick Add (Last Night)
                </button>
            </div>

            <form id="new-session-form" class="grid md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Date</label>
                    <input type="date" id="session-date" name="session_date" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Bedtime</label>
                    <input type="time" id="bedtime" name="bedtime" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Wake Time</label>
                    <input type="time" id="waketime" name="waketime" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Sleep Duration (hours)</label>
                    <input type="number" id="duration" name="duration_hours" min="3" max="16" step="0.1"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all"
                        placeholder="Auto-calculated">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        Efficiency Score (0-100)
                        <span class="text-xs text-slate-500 ml-2">(Auto-calculated)</span>
                    </label>
                    <input type="number" id="efficiency" name="efficiency_score" min="0" max="100" readonly
                        class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-300 cursor-not-allowed"
                        placeholder="Will be calculated automatically">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Morning Mood (1-10)</label>
                    <input type="number" id="morning-mood" name="morning_mood" min="1" max="10"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all"
                        placeholder="Optional" onchange="calculateEfficiency()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Interruptions Count</label>
                    <input type="number" id="interruptions" name="interruptions" min="0" value="0"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all"
                        placeholder="Number of interruptions" onchange="calculateEfficiency()">
                </div>
            </form>

            <div class="flex gap-3 mt-4">
                <button onclick="addSleepSession()"
                    class="flex items-center justify-center gap-2 px-6 py-3 bg-violet-500 hover:bg-violet-600 text-white rounded-xl font-medium transition-all hover:scale-105">
                    <i data-lucide="plus" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                    Add Session
                </button>
                <button onclick="calculateDuration()"
                    class="flex items-center justify-center gap-2 px-6 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-medium transition-colors">
                    <i data-lucide="calculator" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                    Calculate Duration
                </button>
            </div>
        </div>

        <!-- Sleep Sessions Section -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center">
                    <i data-lucide="moon-star" class="w-6 h-6 text-blue-400" style="stroke-width: 1.5;"></i>
                </div>
                <h2 class="text-2xl font-semibold">Sleep Sessions</h2>
                <span id="sessions-count" class="text-sm text-slate-400">(0 sessions)</span>
            </div>

            <div id="sessions-list" class="space-y-3">
                <p class="text-slate-400 text-center py-4">No sleep sessions added yet. Add your first session above.
                </p>
            </div>
        </div>

        <!-- Analysis Results Section -->
        <div id="analysis-results" class="hidden">
            <!-- Sleep Score Card -->
            <div
                class="bg-gradient-to-br from-violet-500/10 to-purple-500/10 border border-violet-500/20 rounded-2xl p-8 mb-6 backdrop-blur-sm">
                <div class="text-center mb-6">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-slate-700 mb-4">
                        <i data-lucide="activity" class="w-4 h-4 text-violet-400" style="stroke-width: 1.5;"></i>
                        <span class="text-sm text-slate-400">Sleep Score</span>
                    </div>
                    <div id="sleep-score"
                        class="text-7xl sm:text-8xl font-light tracking-tight mb-2 text-violet-300 glow">--</div>
                    <div id="confidence" class="text-slate-400 text-sm">Confidence: <span
                            id="confidence-value">--</span>%</div>
                </div>
            </div>

            <!-- Issues Card -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-xl bg-yellow-500/10 flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-400" style="stroke-width: 1.5;"></i>
                    </div>
                    <h2 class="text-2xl font-semibold">Issues Identified</h2>
                </div>
                <ul id="issues-list" class="space-y-3">
                    <!-- Issues will be inserted here -->
                </ul>
            </div>

            <!-- Recommendations Card -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-emerald-400" style="stroke-width: 1.5;"></i>
                    </div>
                    <h2 class="text-2xl font-semibold">Recommendations</h2>
                </div>
                <div id="recommendations-content" class="space-y-4">
                    <!-- Recommendations will be inserted here -->
                </div>
            </div>

            <!-- Personalized Tips Card -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 mb-6 backdrop-blur-sm">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-6 h-6 text-violet-400" style="stroke-width: 1.5;"></i>
                    </div>
                    <h2 class="text-2xl font-semibold">Personalized Tips</h2>
                </div>
                <ul id="tips-list" class="space-y-3">
                    <!-- Tips will be inserted here -->
                </ul>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center mt-8">
            <button id="send-btn" onclick="sendToSupervisor()"
                class="flex items-center justify-center gap-2 px-8 py-4 bg-violet-500 hover:bg-violet-600 text-white rounded-xl font-medium transition-all hover:scale-105 glow mx-auto">
                <i data-lucide="brain" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                Analyze & Get Recommendations
            </button>
        </div>
    </div>

    <!-- Questionnaire Modal -->
    <div id="questionnaire-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="bg-slate-900 border border-slate-800 rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center">
                    <i data-lucide="clipboard-list" class="w-6 h-6 text-violet-400" style="stroke-width: 1.5;"></i>
                </div>
                <h2 class="text-2xl font-semibold">Welcome! Let's Set Up Your Profile</h2>
            </div>
            <p class="text-slate-400 mb-6">Please answer a few questions to help us personalize your sleep
                recommendations.</p>

            <form id="questionnaire-form" class="space-y-6">
                <!-- Age -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">What is your age?</label>
                    <input type="number" id="q-age" name="age" min="1" max="120" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                </div>

                <!-- Work Schedule -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">What is your work schedule?</label>
                    <div class="relative">
                        <select id="q-work_schedule" name="work_schedule" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent appearance-none cursor-pointer transition-all">
                            <option value="">Select your work schedule</option>
                            <option value="9am-5pm">9 AM - 5 PM</option>
                            <option value="flexible">Flexible</option>
                            <option value="night-shift">Night Shift</option>
                            <option value="rotating">Rotating Shifts</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 text-slate-400 absolute right-3 top-3 pointer-events-none"
                            style="stroke-width: 1.5;"></i>
                    </div>
                </div>

                <!-- Caffeine Intake -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">How much caffeine do you consume
                        daily?</label>
                    <div class="relative">
                        <select id="q-caffeine_intake" name="caffeine_intake" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent appearance-none cursor-pointer transition-all">
                            <option value="">Select caffeine intake</option>
                            <option value="none">None</option>
                            <option value="low">Low (1-2 cups/day)</option>
                            <option value="medium">Medium (3-4 cups/day)</option>
                            <option value="high">High (>4 cups/day)</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 text-slate-400 absolute right-3 top-3 pointer-events-none"
                            style="stroke-width: 1.5;"></i>
                    </div>
                </div>

                <!-- Screen Time -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">
                        How many hours do you spend on screens before bed?
                        <span id="q-screen-time-value" class="text-violet-400 ml-2">2 hours</span>
                    </label>
                    <input type="range" id="q-screen_time" name="screen_time" min="0" max="6" step="0.5" value="2"
                        class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500">
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>0h</span>
                        <span>6h</span>
                    </div>
                </div>

                <!-- Exercise Frequency -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">How often do you exercise?</label>
                    <div class="relative">
                        <select id="q-exercise" name="exercise" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-slate-100 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent appearance-none cursor-pointer transition-all">
                            <option value="">Select exercise frequency</option>
                            <option value="daily">Daily</option>
                            <option value="3-4-times">3-4 times per week</option>
                            <option value="1-2-times">1-2 times per week</option>
                            <option value="rarely">Rarely</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 text-slate-400 absolute right-3 top-3 pointer-events-none"
                            style="stroke-width: 1.5;"></i>
                    </div>
                </div>

                <!-- Stress Level -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">
                        What is your typical stress level?
                        <span id="q-stress-level-value" class="text-violet-400 ml-2">3</span>
                    </label>
                    <input type="range" id="q-stress_level" name="stress_level" min="1" max="5" value="3"
                        class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500">
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3 pt-4">
                    <button type="submit"
                        class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-violet-500 hover:bg-violet-600 text-white rounded-xl font-medium transition-all hover:scale-105">
                        <i data-lucide="check" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                        Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Sleep tracking variables
        let sessionStartTime = null;
        let sessionPauseTime = null;
        let totalPauseDuration = 0;
        let pauseCount = 0;
        let interruptionCount = 0;
        let timerInterval = null;
        let sleepTimerInterval = null;
        let isPaused = false;

        // Generate stars background
        function createStars() {
            const container = document.getElementById('stars-container');
            const starCount = 100;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.opacity = Math.random() * 0.5 + 0.3;
                container.appendChild(star);
            }
        }
        createStars();

        // Default placeholder data
        const defaultProfile = {
            age: 25,
            work_schedule: "9am-5pm",
            caffeine_intake: "medium",
            screen_time: 2,
            exercise: "3-4-times",
            stress_level: 3
        };

        // Sleep sessions array (stored in memory)
        let sleepSessions = [];

        // Helper function to get user_id - throws if not available
        function getUserId() {
            const userId = window.supervisorUser?.user_id;
            if (!userId || userId === 'default_user' || userId.trim() === '') {
                throw new Error('User ID not available. Please login through supervisor agent.');
            }
            return userId;
        }

        // Get localStorage key for current user
        function getStorageKey() {
            try {
                const userId = getUserId();
                return `sleep_sessions_${userId}`;
            } catch (error) {
                return 'sleep_sessions_default'; // Fallback, but should not be used
            }
        }

        // Load existing sessions from backend or localStorage
        async function loadExistingSessions() {
            try {
                const userId = getUserId();

                // Try to load from backend first
                try {
                    const response = await fetch(`${API_BASE}/memory?user_id=${userId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.stm && data.stm.sessions && data.stm.sessions.length > 0) {
                            sleepSessions = data.stm.sessions;
                            saveSessions(); // Save to localStorage as backup
                            displaySessions();
                            console.log(`Loaded ${sleepSessions.length} sessions from backend memory for user ${userId}`);
                            return;
                        }
                    }
                } catch (error) {
                    console.log('Could not load from backend, trying localStorage:', error);
                }

                // Fallback to user-specific localStorage
                const storageKey = getStorageKey();
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    sleepSessions = JSON.parse(stored);
                    displaySessions();
                    console.log(`Loaded ${sleepSessions.length} sessions from localStorage for user ${userId}`);
                } else {
                    sleepSessions = [];
                    displaySessions();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showNotification('Cannot load sessions: ' + error.message, 'error');
                sleepSessions = [];
                displaySessions();
            }
        }

        // Backend API endpoint
        const API_BASE = window.location.origin.includes('8000')
            ? window.location.origin
            : 'http://localhost:8000';

        // Supervisor API endpoint
        const SUPERVISOR_API = 'http://localhost:3002';

        // Get user_id from URL parameters or sessionStorage
        function getUserIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id');
        }

        // Check if profile is complete (has all required fields)
        function isProfileComplete(profile) {
            const requiredFields = ['age', 'work_schedule', 'caffeine_intake', 'screen_time', 'exercise', 'stress_level'];
            return requiredFields.every(field => {
                const value = profile[field];
                return value !== undefined && value !== null && value !== '';
            });
        }

        // Show questionnaire modal
        function showQuestionnaire() {
            const modal = document.getElementById('questionnaire-modal');
            if (modal) {
                modal.classList.remove('hidden');
                // Populate questionnaire form with existing values if any
                const profile = window.supervisorUser || {};
                if (profile.age) document.getElementById('q-age').value = profile.age;
                if (profile.work_schedule) document.getElementById('q-work_schedule').value = profile.work_schedule;
                if (profile.caffeine_intake) document.getElementById('q-caffeine_intake').value = profile.caffeine_intake;
                if (profile.screen_time) {
                    document.getElementById('q-screen_time').value = profile.screen_time;
                    document.getElementById('q-screen-time-value').textContent = `${profile.screen_time} hours`;
                }
                if (profile.exercise) document.getElementById('q-exercise').value = profile.exercise;
                if (profile.stress_level) {
                    document.getElementById('q-stress_level').value = profile.stress_level;
                    document.getElementById('q-stress-level-value').textContent = profile.stress_level;
                }
                lucide.createIcons();
            }
        }

        // Hide questionnaire modal
        function hideQuestionnaire() {
            const modal = document.getElementById('questionnaire-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Load user profile - first verify with Supervisor, then load domain data from Worker
        async function loadUserProfile() {
            try {
                // First, try to get user_id from URL (passed from supervisor dashboard)
                let userId = getUserIdFromURL();

                // If not in URL, try sessionStorage (for page refreshes)
                if (!userId) {
                    userId = sessionStorage.getItem('current_user_id');
                }

                // Verify user with Supervisor (authentication only)
                let verifyUrl = `${SUPERVISOR_API}/internal/api/verify_user/${userId}`;
                const verifyResponse = await fetch(verifyUrl);

                if (!verifyResponse.ok || !userId) {
                    throw new Error('Please login through supervisor agent first and access via dashboard');
                }

                const verifyData = await verifyResponse.json();
                if (!verifyData.valid) {
                    throw new Error('Invalid user session. Please login again.');
                }

                // Store user_id in sessionStorage for page refreshes
                sessionStorage.setItem('current_user_id', userId);

                // Set window.supervisorUser with just user_id
                window.supervisorUser = {
                    user_id: userId
                };

                // Now load domain-specific profile from Worker
                const profileResponse = await fetch(`${API_BASE}/api/profile?user_id=${encodeURIComponent(userId)}`);

                let profile = {};
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    profile = profileData.profile || {};

                    // Merge profile into window.supervisorUser
                    window.supervisorUser = {
                        ...window.supervisorUser,
                        ...profile
                    };
                }

                // Check if profile is complete
                if (!isProfileComplete(profile)) {
                    // Show questionnaire for incomplete profile
                    showQuestionnaire();
                }

                // Populate form fields
                document.getElementById('age').value = profile.age || defaultProfile.age;
                document.getElementById('work_schedule').value = profile.work_schedule || defaultProfile.work_schedule;
                document.getElementById('caffeine_intake').value = profile.caffeine_intake || defaultProfile.caffeine_intake;
                document.getElementById('screen_time').value = profile.screen_time || defaultProfile.screen_time;
                document.getElementById('exercise').value = profile.exercise || defaultProfile.exercise;
                document.getElementById('stress_level').value = profile.stress_level || defaultProfile.stress_level;

                console.log('Profile loaded from Worker:', profile, 'User ID:', userId);

                // Update display values
                updateScreenTimeDisplay();
                updateStressLevelDisplay();

                return true;
            } catch (error) {
                console.error('Error loading profile:', error);
                // Show error to user
                showNotification('Cannot load user profile: ' + error.message + '. Please login through supervisor agent.', 'error');

                // Block UI - don't allow using default profile
                document.body.innerHTML = `
                    <div class="min-h-screen bg-slate-950 text-slate-100 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 rounded-full bg-red-500/10 mx-auto mb-4 flex items-center justify-center">
                                <i data-lucide="alert-circle" class="w-8 h-8 text-red-400" style="stroke-width: 1.5;"></i>
                            </div>
                            <h2 class="text-2xl font-semibold mb-2">Authentication Required</h2>
                            <p class="text-slate-400 mb-4">${error.message}</p>
                            <p class="text-slate-500 text-sm mb-4">Please access this page from the Supervisor Dashboard</p>
                            <a href="${SUPERVISOR_API}/login" class="inline-flex items-center gap-2 px-6 py-3 bg-violet-500 hover:bg-violet-600 text-white rounded-xl font-medium transition-colors">
                                <i data-lucide="log-in" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                                Go to Supervisor Login
                            </a>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                throw error;
            }
        }

        // Save profile to Worker (domain-specific data)
        async function saveProfileToWorker() {
            try {
                const profile = getProfileData();
                const userId = getUserId();

                // Save to Worker with user_id in body
                const response = await fetch(`${API_BASE}/api/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        profile: profile
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Profile saved to Worker for user', userId);
                    showNotification('Profile updated successfully!', 'success');

                    // Update window.supervisorUser with new profile
                    if (window.supervisorUser) {
                        window.supervisorUser = {
                            ...window.supervisorUser,
                            ...profile
                        };
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Failed to save profile to Worker:', errorData);
                    showNotification('Failed to update profile. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error saving profile to Worker:', error);
                showNotification('Error updating profile: ' + error.message, 'error');
            }
        }

        // Update screen time display
        function updateScreenTimeDisplay() {
            const value = document.getElementById('screen_time').value;
            document.getElementById('screen-time-value').textContent = `${value} hours`;
        }

        // Update stress level display
        function updateStressLevelDisplay() {
            const value = document.getElementById('stress_level').value;
            document.getElementById('stress-level-value').textContent = value;
        }

        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const currentTimeEl = document.getElementById('current-time');
            const currentDateEl = document.getElementById('current-date');

            if (currentTimeEl) currentTimeEl.textContent = timeString;
            if (currentDateEl) currentDateEl.textContent = dateString;
        }
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        // Sleep tracking functions
        function startSleep() {
            sessionStartTime = new Date();
            sessionPauseTime = null;
            totalPauseDuration = 0;
            pauseCount = 0;
            isPaused = false;

            document.getElementById('session-status').innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-violet-500 session-active"></div>
                    <span>Sleep session active</span>
                `;
            document.getElementById('session-info').textContent = `Started at ${sessionStartTime.toLocaleTimeString()}`;

            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('wake-btn').disabled = false;

            // Update sleep timer
            sleepTimerInterval = setInterval(updateSleepTimer, 1000);
            updateSleepTimer();
        }

        function pauseSleep() {
            if (!isPaused) {
                sessionPauseTime = new Date();
                pauseCount++;
                isPaused = true;

                document.getElementById('total-pauses').textContent = pauseCount;
                const statusEl = document.getElementById('session-status');
                statusEl.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                    <span>Paused</span>
                `;
            } else {
                // Resume
                if (sessionPauseTime) {
                    totalPauseDuration += (new Date() - sessionPauseTime);
                    sessionPauseTime = null;
                }
                isPaused = false;

                const statusEl = document.getElementById('session-status');
                statusEl.innerHTML = `
                        <div class="w-2 h-2 rounded-full bg-violet-500 session-active"></div>
                        <span>Sleep session active</span>
                    `;
            }
        }

        function wakeSleep() {
            if (!sessionStartTime) return;

            const wakeTime = new Date();
            const actualSleepDuration = (wakeTime - sessionStartTime - totalPauseDuration) / (1000 * 60 * 60); // in hours

            // Clear intervals
            if (sleepTimerInterval) {
                clearInterval(sleepTimerInterval);
                sleepTimerInterval = null;
            }

            // Update UI
            document.getElementById('session-status').innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                    <span>Session completed</span>
                `;
            document.getElementById('session-info').textContent = `Sleep duration: ${actualSleepDuration.toFixed(2)} hours`;
            document.getElementById('last-sleep').textContent = `${actualSleepDuration.toFixed(1)}h`;

            // Populate form with session data
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            document.getElementById('session-date').value = yesterday.toISOString().split('T')[0];
            document.getElementById('bedtime').value = sessionStartTime.toTimeString().slice(0, 5);
            document.getElementById('waketime').value = wakeTime.toTimeString().slice(0, 5);
            document.getElementById('duration').value = actualSleepDuration.toFixed(2);
            document.getElementById('interruptions').value = pauseCount;
            interruptionCount = pauseCount;
            document.getElementById('interruption-count').textContent = pauseCount;

            // Calculate efficiency
            calculateEfficiency();

            // Reset buttons
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('wake-btn').disabled = true;

            // Reset timer
            document.getElementById('sleep-timer').textContent = '00:00:00';

            sessionStartTime = null;
            sessionPauseTime = null;
            totalPauseDuration = 0;
            pauseCount = 0;
            isPaused = false;

            showNotification('Sleep session completed! Fill in morning mood and add session.', 'success');
        }

        function updateSleepTimer() {
            if (!sessionStartTime) return;

            const now = new Date();
            let elapsed = now - sessionStartTime - totalPauseDuration;

            if (isPaused && sessionPauseTime) {
                elapsed -= (now - sessionPauseTime);
            }

            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);

            const timerEl = document.getElementById('sleep-timer');
            if (timerEl) {
                timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // Calculate duration from bedtime and waketime
        function calculateDuration() {
            const bedtime = document.getElementById('bedtime').value;
            const waketime = document.getElementById('waketime').value;
            const date = document.getElementById('session-date').value;

            if (!bedtime || !waketime || !date) {
                alert('Please fill in date, bedtime, and wake time first');
                return;
            }

            const bedDateTime = new Date(`${date}T${bedtime}`);
            let wakeDateTime = new Date(`${date}T${waketime}`);

            // If wake time is earlier than bedtime, assume next day
            if (wakeDateTime <= bedDateTime) {
                wakeDateTime.setDate(wakeDateTime.getDate() + 1);
            }

            const durationMs = wakeDateTime - bedDateTime;
            const durationHours = durationMs / (1000 * 60 * 60);

            document.getElementById('duration').value = durationHours.toFixed(2);
            calculateEfficiency();
        }

        // Calculate efficiency score automatically
        function calculateEfficiency() {
            const duration = parseFloat(document.getElementById('duration').value);
            const interruptions = parseInt(document.getElementById('interruptions').value) || 0;
            const morningMood = parseInt(document.getElementById('morning-mood').value);

            if (!duration || isNaN(duration)) {
                document.getElementById('efficiency').value = '';
                return;
            }

            // Base efficiency based on duration (optimal: 7-9 hours = 100%)
            let efficiency = 100;

            // Duration penalty/bonus
            if (duration < 7) {
                // Less than 7 hours: linear decrease
                efficiency = (duration / 7) * 100;
            } else if (duration > 9) {
                // More than 9 hours: slight decrease
                const excess = duration - 9;
                efficiency = Math.max(70, 100 - (excess * 5));
            }

            // Interruption penalty (each interruption reduces by 5-8%)
            const interruptionPenalty = Math.min(interruptions * 7, 30); // Max 30% penalty
            efficiency -= interruptionPenalty;

            // Morning mood adjustment (1-5: negative, 6-10: positive)
            if (morningMood && !isNaN(morningMood)) {
                if (morningMood <= 5) {
                    efficiency -= (6 - morningMood) * 3; // 1 = -15%, 5 = -3%
                } else {
                    efficiency += (morningMood - 5) * 2; // 6 = +2%, 10 = +10%
                }
            }

            // Clamp between 0 and 100
            efficiency = Math.max(0, Math.min(100, Math.round(efficiency)));

            document.getElementById('efficiency').value = efficiency;
        }

        // Quick add last night's sleep
        function quickAddLastNight() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];

            document.getElementById('session-date').value = dateStr;
            document.getElementById('bedtime').value = '22:30';
            document.getElementById('waketime').value = '06:30';
            calculateDuration();
        }

        // Add new sleep session
        async function addSleepSession() {
            const date = document.getElementById('session-date').value;
            const bedtime = document.getElementById('bedtime').value;
            const waketime = document.getElementById('waketime').value;
            let duration = parseFloat(document.getElementById('duration').value);
            const interruptions = parseInt(document.getElementById('interruptions').value) || 0;
            const morningMood = document.getElementById('morning-mood').value ? parseInt(document.getElementById('morning-mood').value) : null;

            if (!date || !bedtime || !waketime) {
                alert('Please fill in date, bedtime, and wake time');
                return;
            }

            // Calculate duration if not provided
            if (!duration || isNaN(duration)) {
                calculateDuration();
                duration = parseFloat(document.getElementById('duration').value);
            }

            // Calculate efficiency if not already calculated
            calculateEfficiency();
            const efficiency = document.getElementById('efficiency').value ? parseInt(document.getElementById('efficiency').value) : null;

            // Create interruptions array
            const interruptionsArray = [];
            for (let i = 0; i < interruptions; i++) {
                interruptionsArray.push({
                    timestamp: new Date().toISOString(),
                    reason: 'Unknown'
                });
            }

            const newSession = {
                session_date: date,
                bedtime: bedtime + ':00',
                waketime: waketime + ':00',
                duration_hours: duration,
                efficiency_score: efficiency,
                morning_mood: morningMood,
                interruptions: interruptionsArray
            };

            sleepSessions.unshift(newSession); // Add to beginning
            saveSessions();
            displaySessions();

            // Save to backend
            try {
                const userId = getUserId();
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        sleep_sessions: [newSession]
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Session saved to backend:', result);

                    // Automatically trigger analysis after saving session
                    try {
                        await triggerAnalysis();
                    } catch (analysisError) {
                        console.error('Error triggering automatic analysis:', analysisError);
                        // Don't show error to user - analysis is optional
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Failed to save session to backend:', errorData.error || 'Unknown error');
                    showNotification('Failed to save session: ' + (errorData.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving session to backend:', error);
                showNotification('Error saving session: ' + error.message, 'error');
            }

            // Clear form
            document.getElementById('new-session-form').reset();
            document.getElementById('interruptions').value = 0;
            document.getElementById('session-date').value = new Date().toISOString().split('T')[0];

            // Show success message
            showNotification('Sleep session added and saved to memory!', 'success');
        }

        // Save sessions to localStorage (user-specific)
        function saveSessions() {
            try {
                const storageKey = getStorageKey();
                localStorage.setItem(storageKey, JSON.stringify(sleepSessions));
            } catch (error) {
                console.error('Error saving sessions to localStorage:', error);
            }
        }

        // Display sleep sessions
        function displaySessions() {
            const sessionsList = document.getElementById('sessions-list');
            const sessionsCount = document.getElementById('sessions-count');

            sessionsList.innerHTML = '';
            sessionsCount.textContent = `(${sleepSessions.length} session${sleepSessions.length !== 1 ? 's' : ''})`;

            if (sleepSessions.length === 0) {
                sessionsList.innerHTML = '<p class="text-slate-400 text-center py-4">No sleep sessions added yet. Add your first session above.</p>';
                return;
            }

            sleepSessions.forEach((session, index) => {
                const sessionCard = document.createElement('div');
                sessionCard.className = 'bg-slate-800/50 border border-slate-700 rounded-xl p-4 flex items-center justify-between hover:border-slate-600 transition-colors';
                sessionCard.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                            <i data-lucide="moon" class="w-5 h-5 text-blue-400" style="stroke-width: 1.5;"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-slate-300">${session.session_date}</div>
                            <div class="text-xs text-slate-500">${session.bedtime.slice(0, 5)} - ${session.waketime.slice(0, 5)}</div>
                        </div>
                    </div>
                    <div class="text-right mr-4">
                        <div class="text-lg font-semibold text-slate-100">${session.duration_hours.toFixed(1)}h</div>
                        <div class="text-xs text-slate-500">${session.efficiency_score ? `Efficiency: ${session.efficiency_score}%` : 'No efficiency data'}</div>
                    </div>
                    <button onclick="removeSession(${index})" class="p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4" style="stroke-width: 1.5;"></i>
                    </button>
                `;
                sessionsList.appendChild(sessionCard);
            });

            lucide.createIcons();
        }

        // Remove session
        function removeSession(index) {
            if (confirm('Are you sure you want to remove this sleep session?')) {
                sleepSessions.splice(index, 1);
                saveSessions();
                displaySessions();
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-xl shadow-lg backdrop-blur-sm border ${type === 'success' ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300' :
                type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-300' :
                    'bg-blue-500/20 border-blue-500/50 text-blue-300'
                }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}" class="w-5 h-5" style="stroke-width: 1.5;"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            lucide.createIcons();

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Fetch analysis results from backend
        async function fetchAnalysisResults() {
            try {
                const userId = getUserId();
                const profile = getProfileData();

                try {
                    // Send request to backend to get analysis
                    const response = await fetch(`${API_BASE}/api/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            profile: profile,
                            sleep_sessions: sleepSessions
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    displayAnalysisResults({ result: data });
                } catch (error) {
                    console.error('Error fetching analysis:', error);
                    // Try to get recommendations from memory
                    try {
                        const recResponse = await fetch(`${API_BASE}/api/recommendations/${userId}`);
                        if (recResponse.ok) {
                            const recData = await recResponse.json();
                            displayAnalysisResults({
                                result: {
                                    sleep_score: recData.sleep_score || 0,
                                    confidence: recData.confidence || 0,
                                    issues: recData.issues || [],
                                    recommendations: recData.recommendations || {},
                                    personalized_tips: recData.personalized_tips || []
                                }
                            });
                            return;
                        }
                    } catch (recError) {
                        console.error('Error fetching recommendations:', recError);
                    }
                    // Show placeholder if backend is not available
                    displayAnalysisResults(null);
                }
            } catch (error) {
                console.error('Cannot fetch analysis:', error.message);
                showNotification('Cannot analyze: ' + error.message, 'error');
            }
        }

        // Trigger analysis automatically (without button UI changes)
        async function triggerAnalysis() {
            try {
                const profile = getProfileData();
                const userId = getUserId();

                // Get analysis and recommendations
                const payload = {
                    user_id: userId,
                    profile: profile,
                    sleep_sessions: sleepSessions
                };

                // Send to backend for analysis
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Display analysis results
                displayAnalysisResults({ result: result });

                console.log('Automatic analysis completed');
            } catch (error) {
                console.error('Error in automatic analysis:', error);
                // Silently fail - user can manually trigger analysis if needed
            }
        }

        // Get profile data from form
        function getProfileData() {
            return {
                age: parseInt(document.getElementById('age').value),
                work_schedule: document.getElementById('work_schedule').value,
                caffeine_intake: document.getElementById('caffeine_intake').value,
                screen_time: parseFloat(document.getElementById('screen_time').value),
                exercise: document.getElementById('exercise').value,
                stress_level: parseInt(document.getElementById('stress_level').value)
            };
        }

        // Display analysis results
        function displayAnalysisResults(data) {
            // Use provided data or placeholder
            const analysisResults = data?.result || {
                sleep_score: 0,
                confidence: 0,
                issues: ["No analysis data available. Send data to Supervisor Agent to get insights."],
                recommendations: {
                    ideal_sleep_window: {
                        recommended_bedtime: "--:--",
                        recommended_waketime: "--:--"
                    },
                    caffeine_cutoff: {
                        recommendation: "No recommendation available"
                    }
                },
                personalized_tips: ["Add sleep sessions and send to Supervisor Agent to get personalized tips"]
            };

            // Display sleep score
            document.getElementById('sleep-score').textContent = analysisResults.sleep_score || '--';
            document.getElementById('confidence-value').textContent = analysisResults.confidence ? (analysisResults.confidence * 100).toFixed(0) : '--';

            // Display issues
            const issuesList = document.getElementById('issues-list');
            if (analysisResults.issues && analysisResults.issues.length > 0) {
                issuesList.innerHTML = analysisResults.issues.map(issue => `
                    <li class="flex items-start gap-3 text-slate-300">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-400 mt-0.5 flex-shrink-0" style="stroke-width: 1.5;"></i>
                        <span>${issue}</span>
                    </li>
                `).join('');
            } else {
                issuesList.innerHTML = '<li class="text-slate-400 text-center py-2">No issues identified</li>';
            }

            // Display recommendations
            const recommendationsContent = document.getElementById('recommendations-content');
            const recs = analysisResults.recommendations || {};
            recommendationsContent.innerHTML = `
                ${recs.ideal_sleep_window ? `
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <div class="flex items-center gap-2 text-slate-400 text-sm mb-2">
                        <i data-lucide="moon" class="w-4 h-4" style="stroke-width: 1.5;"></i>
                        <span>Ideal Sleep Window</span>
                    </div>
                    <div class="text-lg font-semibold text-slate-100">
                        ${recs.ideal_sleep_window.recommended_bedtime || '--:--'} - ${recs.ideal_sleep_window.recommended_waketime || '--:--'}
                    </div>
                </div>
                ` : ''}
                ${recs.caffeine_cutoff ? `
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <div class="flex items-center gap-2 text-slate-400 text-sm mb-2">
                        <i data-lucide="coffee" class="w-4 h-4" style="stroke-width: 1.5;"></i>
                        <span>Caffeine Cutoff</span>
                    </div>
                    <div class="text-sm text-slate-300">
                        ${recs.caffeine_cutoff.recommendation || recs.caffeine_cutoff.cutoff_time || 'No recommendation'}
                    </div>
                </div>
                ` : ''}
            `;

            // Display tips
            const tipsList = document.getElementById('tips-list');
            if (analysisResults.personalized_tips && analysisResults.personalized_tips.length > 0) {
                tipsList.innerHTML = analysisResults.personalized_tips.map(tip => `
                    <li class="flex items-start gap-3 text-slate-300">
                        <i data-lucide="check-circle" class="w-5 h-5 text-violet-400 mt-0.5 flex-shrink-0" style="stroke-width: 1.5;"></i>
                        <span>${tip}</span>
                    </li>
                `).join('');
            } else {
                tipsList.innerHTML = '<li class="text-slate-400 text-center py-2">No tips available</li>';
            }

            // Show analysis results section
            document.getElementById('analysis-results').classList.remove('hidden');

            lucide.createIcons();
        }

        // Send to Backend for Analysis
        async function sendToSupervisor() {
            const btn = document.getElementById('send-btn');
            const originalText = btn.innerHTML;

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin" style="stroke-width: 1.5;"></i> Analyzing...';
            lucide.createIcons();

            try {
                const profile = getProfileData();
                const userId = getUserId();

                // First, save all sessions to backend
                if (sleepSessions.length > 0) {
                    try {
                        const saveResponse = await fetch(`${API_BASE}/api/sessions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: userId,
                                sleep_sessions: sleepSessions
                            })
                        });

                        if (saveResponse.ok) {
                            const saveResult = await saveResponse.json();
                            console.log('Sessions saved to memory:', saveResult);
                        } else {
                            const errorData = await saveResponse.json().catch(() => ({}));
                            throw new Error(errorData.error || 'Failed to save sessions');
                        }
                    } catch (saveError) {
                        console.error('Error saving sessions:', saveError);
                        throw saveError;
                    }
                }

                // Then get analysis and recommendations
                const payload = {
                    user_id: userId,
                    profile: profile,
                    sleep_sessions: sleepSessions
                };

                // Send to backend for analysis
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Show success message
                btn.innerHTML = '<i data-lucide="check" class="w-5 h-5" style="stroke-width: 1.5;"></i> Analyzed!';
                btn.classList.remove('bg-violet-500', 'hover:bg-violet-600');
                btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
                lucide.createIcons();

                showNotification('Data analyzed and saved to memory successfully!', 'success');

                // Display analysis results
                displayAnalysisResults({ result: result });

                // Reset button after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                    btn.classList.add('bg-violet-500', 'hover:bg-violet-600');
                    btn.disabled = false;
                    lucide.createIcons();
                }, 2000);

            } catch (error) {
                console.error('Error analyzing data:', error);
                showNotification(`Failed to analyze: ${error.message}`, 'error');

                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // Questionnaire form submission
        document.getElementById('questionnaire-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const userId = getUserId();
                const profile = {
                    age: parseInt(document.getElementById('q-age').value),
                    work_schedule: document.getElementById('q-work_schedule').value,
                    caffeine_intake: document.getElementById('q-caffeine_intake').value,
                    screen_time: parseFloat(document.getElementById('q-screen_time').value),
                    exercise: document.getElementById('q-exercise').value,
                    stress_level: parseInt(document.getElementById('q-stress_level').value)
                };

                // Save profile to Worker
                const response = await fetch(`${API_BASE}/api/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        profile: profile
                    })
                });

                if (response.ok) {
                    // Update window.supervisorUser
                    window.supervisorUser = {
                        ...window.supervisorUser,
                        ...profile
                    };

                    // Populate main form fields
                    document.getElementById('age').value = profile.age;
                    document.getElementById('work_schedule').value = profile.work_schedule;
                    document.getElementById('caffeine_intake').value = profile.caffeine_intake;
                    document.getElementById('screen_time').value = profile.screen_time;
                    document.getElementById('exercise').value = profile.exercise;
                    document.getElementById('stress_level').value = profile.stress_level;

                    // Update display values
                    updateScreenTimeDisplay();
                    updateStressLevelDisplay();

                    // Hide questionnaire
                    hideQuestionnaire();

                    showNotification('Profile saved successfully!', 'success');
                    lucide.createIcons();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showNotification('Failed to save profile: ' + (errorData.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving questionnaire:', error);
                showNotification('Error saving profile: ' + error.message, 'error');
            }
        });

        // Questionnaire slider updates
        document.getElementById('q-screen_time').addEventListener('input', (e) => {
            document.getElementById('q-screen-time-value').textContent = `${e.target.value} hours`;
        });
        document.getElementById('q-stress_level').addEventListener('input', (e) => {
            document.getElementById('q-stress-level-value').textContent = e.target.value;
        });

        // Event listeners
        document.getElementById('screen_time').addEventListener('input', () => {
            updateScreenTimeDisplay();
            saveProfileToWorker();
        });
        document.getElementById('stress_level').addEventListener('input', () => {
            updateStressLevelDisplay();
            saveProfileToWorker();
        });
        document.getElementById('bedtime').addEventListener('change', calculateDuration);
        document.getElementById('waketime').addEventListener('change', calculateDuration);
        document.getElementById('duration').addEventListener('input', calculateEfficiency);

        // Save profile when other fields change
        ['age', 'work_schedule', 'caffeine_intake', 'exercise'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('change', saveProfileToWorker);
            }
        });

        // Initialize on load - ensure profile loads before sessions
        (async () => {
            try {
                // First, load user profile (this will throw if not authenticated)
                await loadUserProfile();

                // Then load sessions (only after profile is loaded)
                await loadExistingSessions();
                displaySessions();

                // Set today's date as default
                document.getElementById('session-date').value = new Date().toISOString().split('T')[0];

                // Try to fetch analysis results on load if we have sessions
                try {
                    const userId = getUserId();
                    if (sleepSessions.length > 0) {
                        fetchAnalysisResults();
                    }
                } catch (error) {
                    // User ID not available, skip analysis
                    console.log('Skipping analysis fetch:', error.message);
                }
            } catch (error) {
                // Error already handled in loadUserProfile (shows login page)
                console.error('Initialization error:', error);
            }
        })();
    </script>
</body>

</html>